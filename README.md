# CityLadder ðŸ™ï¸

**Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¸Ð³Ñ€Ð° "Ð“Ð¾Ñ€Ð¾Ð´ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸"** â€” Telegram MiniApp Ð³Ð´Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ¸ ÑÑ‚Ñ€Ð¾ÑÑ‚ Ð³Ð¾Ñ€Ð¾Ð´Ð°, Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐ°ÑŽÑ‚ Ð¶Ð¸Ñ‚ÐµÐ»ÐµÐ¹ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ Ð·Ð²Ñ‘Ð·Ð´Ñ‹ â­ï¸ (Telegram Stars).

## ðŸŽ® Ð˜Ð³Ñ€Ð¾Ð²Ñ‹Ðµ Ð¼ÐµÑ…Ð°Ð½Ð¸ÐºÐ¸

### ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð´ÐµÑ
ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¸Ð³Ñ€Ð¾Ðº ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ ÑÐ²Ð¾Ð¹ Ð³Ð¾Ñ€Ð¾Ð´, ÑÐ¾ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¸Ð· Ð´Ð¾Ð¼Ð¾Ð² Ð¸ Ð·Ð°Ð²Ð¾Ð´Ð°. Ð“Ð¾Ñ€Ð¾Ð´ Ñ€Ð°ÑÑ‚Ñ‘Ñ‚ Ð²Ð²ÐµÑ€Ñ… Ð·Ð° ÑÑ‡Ñ‘Ñ‚ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÑ‘Ð½Ð½Ñ‹Ñ… Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð², Ñ‡Ñ‚Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð³Ð»ÑƒÐ±Ð¸Ð½Ñƒ Ð´Ð¾Ñ…Ð¾Ð´Ð°.

### Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸ÐºÐ°

#### ðŸ’° Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸
- **Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ€Ð¾Ð´Ð°**: 3â­ï¸ (Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ð¾, Ð´Ð°Ñ‘Ñ‚ 2 Ð´Ð¾Ð¼Ð° + 1 Ð·Ð°Ð²Ð¾Ð´)
- **ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²Ð¾Ð´Ð°**: 10â­ï¸ Ð·Ð° 24 Ñ‡Ð°ÑÐ°

#### ðŸ“Š Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸ Ð¿Ð¾ ÑƒÑ€Ð¾Ð²Ð½ÑÐ¼

| Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ | Ð˜Ð³Ñ€Ð¾ÐºÐ¾Ð² | ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚ | ÐŸÑ€Ð¸Ð¼ÐµÑ€ (Ð·Ð° 10â­ï¸) |
|---------|---------|---------|-----------------|
| 1       | Ð´Ð¾ 3    | 40%     | 4â­ï¸ Ð½Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° |
| 2       | Ð´Ð¾ 9    | 25%     | 2.5â­ï¸ Ð½Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° |
| 3       | Ð´Ð¾ 27   | 17%     | 1.7â­ï¸ Ð½Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° |
| 4       | Ð´Ð¾ 81   | 10%     | 1â­ï¸ Ð½Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° |
| 5       | Ð´Ð¾ 243  | 5%      | 0.5â­ï¸ Ð½Ð° Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° |

**Ð’Ð°Ð¶Ð½Ð¾**: ÐŸÑ€Ð¸Ð±Ñ‹Ð»ÑŒ Ð²Ñ‹Ð¿Ð»Ð°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ÑÑ **ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ** Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸.

### ðŸ—ï¸ Ð Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ Ð³Ð¾Ñ€Ð¾Ð´Ð°

Ð“Ð¾Ñ€Ð¾Ð´ Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ñ€Ð¾Ð³Ð¾Ð² Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð²:

| Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ | Ð”Ð¾Ð¼Ð° | Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð´Ð¾Ñ…Ð¾Ð´Ð° | Ð ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð² |
|---------|------|---------------|-----------|
| 1       | 2    | 1             | 0         |
| 2       | 2    | 2             | 0-14      |
| 3       | 3    | 3             | 15-34     |
| 4       | 4    | 4             | 35-69     |
| 5       | 5    | 5             | 70+       |

### ðŸ‘¥ Ð ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°

- **ÐŸÑ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ**: Ð˜Ð³Ñ€Ð¾Ðº Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ Ð´Ñ€ÑƒÐ·ÐµÐ¹
- **Ð‘Ð¾Ð½ÑƒÑ**: +0.5â­ï¸ Ð·Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸ÑŽ Ð·Ð°Ð²Ð¾Ð´Ð° Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð°
- **Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°**: Ð ÐµÑ„ÐµÑ€Ð°Ð»Ñ‹ Ð·Ð°ÑÐµÐ»ÑÑŽÑ‚ÑÑ Ð² Ð³Ð¾Ñ€Ð¾Ð´Ð° Ð¿Ð¾ ÑƒÑ€Ð¾Ð²Ð½ÑÐ¼ Ð±Ð»Ð¸Ð·Ð¾ÑÑ‚Ð¸

### ðŸ† Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³

ÐšÐ°Ð¶Ð´ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ Ð½Ð°Ñ‡Ð¸ÑÐ»ÑÑŽÑ‚ÑÑ Ð½Ð°Ð³Ñ€Ð°Ð´Ñ‹ Ð·Ð° ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÑ‘Ð½Ð½Ñ‹Ñ…:

| ÐœÐµÑÑ‚Ð¾ | ÐÐ°Ð³Ñ€Ð°Ð´Ð° |
|-------|---------|
| ðŸ¥‡ 1  | 100â­ï¸   |
| ðŸ¥ˆ 2  | 75â­ï¸    |
| ðŸ¥‰ 3  | 50â­ï¸    |
| 4     | 25â­ï¸    |
| 5     | 15â­ï¸    |

## ðŸ“± Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ MiniApp

### 5 Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð²ÐºÐ»Ð°Ð´Ð¾Ðº

1. **ðŸ™ï¸ Ð“Ð¾Ñ€Ð¾Ð´** â€” Ð‘Ð°Ð»Ð°Ð½Ñ, ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°Ð²Ð¾Ð´Ð°, ÐºÐ½Ð¾Ð¿ÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸
2. **ðŸ‘¥ Ð–Ð¸Ñ‚ÐµÐ»Ð¸** â€” Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ€ÐµÑ„ÐµÑ€Ð°Ð»Ð¾Ð², Ñ€ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑÑ‹Ð»ÐºÐ°, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð³Ð¾Ñ€Ð¾Ð´Ð°
3. **ðŸ’¸ Ð”Ð¾Ñ…Ð¾Ð´** â€” Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸, Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¹, ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
4. **ðŸ—ï¸ Ð¡Ñ‚Ñ€Ð¾Ð¸Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾** â€” Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð°Ð¿Ð³Ñ€ÐµÐ¹Ð´Ð°Ñ… Ð³Ð¾Ñ€Ð¾Ð´Ð°, Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ
5. **âš™ï¸ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ** â€” Ð˜Ð½Ñ„Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ°, ÐµÐ¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³, ÑÐ¿Ñ€Ð°Ð²ÐºÐ°, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°

## ðŸ—ï¸ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

```
cityladder/
â”œâ”€â”€ server.js                          # Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ entry point
â”œâ”€â”€ package.json                       # Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
â”œâ”€â”€ index.html                         # HTML entry for frontend
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server/                        # Backend
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”œâ”€â”€ client.js             # PostgreSQL client
â”‚   â”‚   â”‚   â””â”€â”€ init.js               # Schema initialization
â”‚   â”‚   â”œâ”€â”€ bot/
â”‚   â”‚   â”‚   â”œâ”€â”€ webhook.js            # Bot webhook handler
â”‚   â”‚   â”‚   â””â”€â”€ handlers.js           # Bot command handlers
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ userService.js        # User management
â”‚   â”‚   â”‚   â”œâ”€â”€ cityService.js        # City & house management
â”‚   â”‚   â”‚   â”œâ”€â”€ factoryService.js     # Factory & profit logic
â”‚   â”‚   â”‚   â”œâ”€â”€ referralService.js    # Referral system
â”‚   â”‚   â”‚   â”œâ”€â”€ ratingService.js      # Weekly ratings
â”‚   â”‚   â”‚   â””â”€â”€ schedulerService.js   # Background tasks
â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚       â”œâ”€â”€ bot.js                # Bot webhook routes
â”‚   â”‚       â””â”€â”€ api.js                # REST API routes
â”‚   â”‚
â”‚   â””â”€â”€ frontend/                      # Frontend MiniApp
â”‚       â”œâ”€â”€ main.jsx                  # React entry point
â”‚       â”œâ”€â”€ App.jsx                   # Main app with nav
â”‚       â”œâ”€â”€ context/
â”‚       â”‚   â””â”€â”€ AppContext.js         # Global state
â”‚       â”œâ”€â”€ tabs/
â”‚       â”‚   â”œâ”€â”€ CityTab.jsx           # City tab
â”‚       â”‚   â”œâ”€â”€ CitizensTab.jsx       # Citizens/referrals tab
â”‚       â”‚   â”œâ”€â”€ IncomeTab.jsx         # Income history tab
â”‚       â”‚   â”œâ”€â”€ ConstructionTab.jsx   # City upgrades tab
â”‚       â”‚   â””â”€â”€ ProfileTab.jsx        # Profile & ratings tab
â”‚       â””â”€â”€ styles/
â”‚           â”œâ”€â”€ global.css            # Global styles
â”‚           â”œâ”€â”€ App.css               # App layout
â”‚           â””â”€â”€ tabs.css              # Tab styles
â”‚
â”œâ”€â”€ Dockerfile                         # Docker config
â”œâ”€â”€ railway.toml                       # Railway config
â”œâ”€â”€ DEPLOYMENT.md                      # Deployment guide
â””â”€â”€ README.md                          # This file
```

## ðŸ—„ï¸ Database Schema

### Users
- `id` â€” Primary key
- `telegram_id` â€” Telegram ID (unique)
- `username` â€” Telegram username
- `first_name` â€” First name
- `referrer_id` â€” Referrer's user ID
- `created_at` â€” Account creation date

### Cities
- `id` â€” Primary key
- `user_id` â€” Owner user ID (foreign key)
- `level` â€” City level (1-5)
- `houses` â€” Number of houses
- `balance` â€” Star balance
- `created_at`, `updated_at`

### Factories
- `id` â€” Primary key
- `city_id` â€” Owner city ID (foreign key)
- `is_active` â€” Activation status
- `activated_at` â€” Activation timestamp
- `deactivates_at` â€” Deactivation timestamp
- `created_at`, `updated_at`

### Referrals
- `id` â€” Primary key
- `referrer_id` â€” Referrer user ID (foreign key)
- `referred_id` â€” Referred user ID (foreign key)
- `level` â€” Network level depth
- `activated_factory_bonus_claimed` â€” Bonus claim status
- `created_at`

### Transactions
- `id` â€” Primary key
- `user_id` â€” Owner user ID (foreign key)
- `type` â€” Transaction type
- `amount` â€” Star amount
- `description` â€” Details
- `source_user_id` â€” Source user (for profits)
- `level_income_from` â€” Income level
- `created_at`

### Weekly Ratings
- `id` â€” Primary key
- `week_start` â€” Week start date
- `user_id` â€” User ID (foreign key)
- `referral_count` â€” Referral count for week
- `rank` â€” Weekly rank
- `reward_claimed` â€” Reward claim status
- `created_at`

## ðŸ”„ Scheduler Tasks

### Profit Processing (Every 1 minute)
1. Find all active factories
2. For each factory owner, traverse referral chain
3. Calculate profit at each level based on percentage
4. Add hourly portion to each referrer's balance
5. Deactivate expired factories

### Rating Updates (Every 1 hour)
1. Count referrals for each user
2. Sort by referral count
3. Update weekly_ratings table
4. Assign ranks 1-âˆž

### Weekly Rewards (Daily at midnight UTC)
1. Get current week's ratings
2. For top 5, add reward to balance
3. Mark reward as claimed
4. Record transaction

## ðŸš€ Development

### Local Setup
```bash
npm install
npm run dev
```

Server: http://localhost:8080
Frontend: http://localhost:3001 (via Vite proxy)

### Build for Production
```bash
npm run build
```

Output: `dist/` folder with built frontend

## ðŸ“¡ API Endpoints

### Authentication
All endpoints require `user_id` parameter (Telegram ID).

### User
- `GET /api/user/profile` â€” Get user profile

### City
- `GET /api/city/stats` â€” Get city stats & factories
- `POST /api/city/build-house` â€” Build house (upgrade city)

### Factory
- `POST /api/factory/activate` â€” Activate factory for 24h

### Referrals
- `GET /api/referrals` â€” Get referral list & link

### Income
- `GET /api/transactions` â€” Get transaction history

### Rating
- `GET /api/rating/weekly` â€” Get weekly ratings

## ðŸ¤– Telegram Bot

### Commands
- `/start` â€” Welcome message with MiniApp button
- `callback_query` â€” Button handlers (rules, support)

### Webhook
- URL: `https://cryptoladder-production.up.railway.app/bot/webhook`
- Method: POST
- Telegram sends updates to this endpoint

## ðŸ” Security

- **Bot**: Token in environment variable
- **Database**: SSL/TLS connection required
- **API**: User authentication via Telegram ID
- **Secrets**: Never committed to repository

## ðŸ“ˆ Game Balance

### Economy
- Factory cost (10â­ï¸) should equal ~10 hours of profit from 1st level
- Profit percentages decrease with depth to prevent infinite loops
- Weekly rewards encourage activity without breaking economy

### Growth
- 1st level: 3 players â€” easy to fill
- 2nd level: 9 players â€” encourages sharing
- 3rd level: 27 players â€” real network effect
- 4th-5th: Exponential growth â€” aspirational targets

### Anti-Fraud
- Telegram ID validation prevents bot accounts
- Factory requires balance deduction (no free farming)
- Referral structure prevents self-referencing

## ðŸ› Troubleshooting

### Factory not activating
- Check if user has balance >= 10â­ï¸
- Verify city exists in database
- Check for database connection errors

### Profit not showing
- Verify factory is_active = true
- Check deactivates_at > now()
- Ensure referrer has referral records
- Check profit processing in scheduler logs

### Bot not responding
- Verify BOT_TOKEN is correct
- Check webhook URL in Telegram
- Review server logs for errors

## ðŸ“ž Support
- Telegram: @cryptoladder_support
- Email: support@cityladder.app (if available)

## ðŸ“œ License
Private project â€” All rights reserved Â© 2024
