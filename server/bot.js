import { Telegraf } from 'telegraf';
import { getOrCreateUser } from './services/userService.js';

export function createBot(token, webAppUrl) {
  const bot = new Telegraf(token);

  bot.start(async (ctx) => {
    try {
      const telegramId = ctx.from.id;
      const userData = {
        username: ctx.from.username,
        first_name: ctx.from.first_name,
        last_name: ctx.from.last_name,
      };

      // Get or create user
      await getOrCreateUser(telegramId, userData);

      const greeting = `üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Crypto Ladder!

–≠—Ç–æ —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–∞—è –ø–∏—Ä–∞–º–∏–¥–∞ —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π, –≥–¥–µ –≤—ã –º–æ–∂–µ—Ç–µ:
üí∞ –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–≤—ë–∑–¥—ã ‚≠êÔ∏è –æ—Ç –∏–≥—Ä–æ–∫–æ–≤ –ø–æ–¥ –≤–∞–º–∏
üë• –ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã
üìà –°—Ç—Ä–æ–∏—Ç—å —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—ÄÔøΩÔøΩ

–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å!`;

      ctx.reply(greeting, {
        reply_markup: {
          inline_keyboard: [
            [
              {
                text: 'üéÆ –û—Ç–∫—Ä—ã—Ç—å Crypto Ladder',
                web_app: {
                  url: webAppUrl,
                },
              },
            ],
          ],
        },
      });
    } catch (error) {
      console.error('Error in /start command:', error);
      ctx.reply('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  });

  bot.help((ctx) => {
    ctx.reply(`
üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ Crypto Ladder:

üéØ –ö–∞–∫ –Ω–∞—á–∞—Ç—å:
1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç (10 ‚≠êÔ∏è)
3. –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ

üíé –°–∏—Å—Ç–µ–º–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞:
- –£—Ä–æ–≤–µ–Ω—å 1: 35% –æ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø–æ–¥ –≤–∞–º–∏
- –£—Ä–æ–≤–µ–Ω—å 2: 21%
- –£—Ä–æ–≤–µ–Ω—å 3: 14%
- –£—Ä–æ–≤–µ–Ω—å 4: 8%
- –£—Ä–æ–≤–µ–Ω—å 5: 4%

üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:
- –ü–æ–ª—É—á–∞–π—Ç–µ 0.5 ‚≠êÔ∏è –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞
- –ì–ª—É–±–∏–Ω–∞ –¥–æÔøΩÔøΩ–æ–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–∞:
- –ë–µ–∑ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç–µ –¥–æ—Ö–æ–¥
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤—É–µ—Ç 24 —á–∞—Å–∞
- –ù–µ–ª—å–∑—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –ø–æ–∫—É–ø–∫–∏ –º–µ—Å—Ç–∞ (3 ‚≠êÔ∏è)
    `);
  });

  return bot;
}
